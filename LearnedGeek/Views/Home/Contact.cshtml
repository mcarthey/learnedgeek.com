@model ContactFormModel
@{
    ViewData["Title"] = "Contact";
    var showSuccess = TempData["ContactSuccess"] != null;
    var recaptchaSiteKey = ViewBag.RecaptchaSiteKey as string;
}

<div class="bg-white">
    <!-- Header -->
    <section class="py-24 lg:py-32 border-b border-neutral-200">
        <div class="max-w-6xl mx-auto px-6 lg:px-8">
            <span class="text-xs font-semibold text-neutral-400 uppercase tracking-widest">
                Contact
            </span>
            <h1 class="mt-4 text-4xl md:text-5xl font-semibold text-neutral-900 leading-tight max-w-2xl">
                Get in touch
            </h1>
            <p class="mt-6 text-lg text-neutral-600 max-w-xl">
                Have a project, question, or just want to connect?
                I'd be happy to hear from you.
            </p>
        </div>
    </section>

    <!-- Contact Content -->
    <section class="py-24 lg:py-32">
        <div class="max-w-6xl mx-auto px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-16 lg:gap-24">
                <!-- Form -->
                <div class="lg:col-span-7">
                    @if (showSuccess)
                    {
                        <div class="text-center py-16">
                            <div class="inline-flex items-center justify-center h-16 w-16 border border-neutral-200 mb-6">
                                <span class="text-neutral-600">
                                    <partial name="Icons/_CheckCircle" />
                                </span>
                            </div>
                            <h3 class="text-xl font-semibold text-neutral-900 mb-2">
                                Message received
                            </h3>
                            <p class="text-neutral-500 max-w-sm mx-auto">
                                Thank you for reaching out. I'll get back to you as soon as possible.
                            </p>
                        </div>
                    }
                    else
                    {
                        <form asp-action="Contact" method="post" class="space-y-6" id="contactForm">
                            @Html.AntiForgeryToken()

                            @* Honeypot field - hidden from real users, bots will fill it *@
                            <div style="position: absolute; left: -5000px;" aria-hidden="true">
                                <input type="text" name="Website" tabindex="-1" autocomplete="off" asp-for="Website">
                            </div>

                            @* Hidden field for reCAPTCHA token *@
                            <input type="hidden" asp-for="RecaptchaToken" id="recaptchaToken">

                            @if (!ViewData.ModelState.IsValid)
                            {
                                <div asp-validation-summary="All" class="text-red-600 text-sm mb-4"></div>
                            }

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label asp-for="Name" class="text-sm font-medium text-neutral-700 block">
                                        Name
                                    </label>
                                    <input asp-for="Name"
                                           type="text"
                                           required
                                           class="w-full px-4 py-3 border border-neutral-300 focus:border-neutral-900 focus:ring-1 focus:ring-neutral-900 focus:outline-none transition-colors"
                                           placeholder="Your name" />
                                    <span asp-validation-for="Name" class="text-red-600 text-xs"></span>
                                </div>
                                <div class="space-y-2">
                                    <label asp-for="Email" class="text-sm font-medium text-neutral-700 block">
                                        Email
                                    </label>
                                    <input asp-for="Email"
                                           type="email"
                                           required
                                           class="w-full px-4 py-3 border border-neutral-300 focus:border-neutral-900 focus:ring-1 focus:ring-neutral-900 focus:outline-none transition-colors"
                                           placeholder="you@example.com" />
                                    <span asp-validation-for="Email" class="text-red-600 text-xs"></span>
                                </div>
                            </div>

                            <div class="space-y-2">
                                <label asp-for="Subject" class="text-sm font-medium text-neutral-700 block">
                                    Subject
                                </label>
                                <input asp-for="Subject"
                                       type="text"
                                       required
                                       class="w-full px-4 py-3 border border-neutral-300 focus:border-neutral-900 focus:ring-1 focus:ring-neutral-900 focus:outline-none transition-colors"
                                       placeholder="What's this about?" />
                                <span asp-validation-for="Subject" class="text-red-600 text-xs"></span>
                            </div>

                            <div class="space-y-2">
                                <label asp-for="Message" class="text-sm font-medium text-neutral-700 block">
                                    Message
                                </label>
                                <textarea asp-for="Message"
                                          required
                                          rows="6"
                                          class="w-full px-4 py-3 border border-neutral-300 focus:border-neutral-900 focus:ring-1 focus:ring-neutral-900 focus:outline-none transition-colors resize-none"
                                          placeholder="Tell me about your project or question..."></textarea>
                                <span asp-validation-for="Message" class="text-red-600 text-xs"></span>
                            </div>

                            <button type="submit"
                                    id="submitBtn"
                                    class="inline-flex items-center gap-2 px-8 py-3 bg-neutral-900 text-white font-medium hover:bg-neutral-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="btn-text">Send Message</span>
                                <span class="btn-loading hidden">Sending...</span>
                                <partial name="Icons/_ArrowRight" />
                            </button>

                            @if (!string.IsNullOrEmpty(recaptchaSiteKey))
                            {
                                <p class="mt-4 text-xs text-neutral-400 leading-relaxed">
                                    This site is protected by reCAPTCHA and the Google
                                    <a href="https://policies.google.com/privacy" target="_blank" rel="noopener" class="underline hover:text-neutral-600">Privacy Policy</a> and
                                    <a href="https://policies.google.com/terms" target="_blank" rel="noopener" class="underline hover:text-neutral-600">Terms of Service</a> apply.
                                </p>
                            }
                        </form>
                    }
                </div>

                <!-- Sidebar -->
                <div class="lg:col-span-5">
                    <div class="lg:sticky lg:top-24 space-y-12">
                        <!-- Direct Email (obfuscated to prevent scraping) -->
                        <div class="p-8 bg-neutral-50 border border-neutral-200">
                            <h3 class="text-xs font-semibold text-neutral-400 uppercase tracking-widest mb-4">
                                Direct Email
                            </h3>
                            <a id="contact-email" href="#"
                               data-user="hello" data-domain="learnedgeek.com"
                               class="flex items-center gap-3 group">
                                <div class="h-10 w-10 border border-neutral-300 flex items-center justify-center group-hover:border-neutral-900 transition-colors">
                                    <span class="text-neutral-600 group-hover:text-neutral-900 transition-colors">
                                        <partial name="Icons/_Mail" />
                                    </span>
                                </div>
                                <span id="contact-email-text" class="text-neutral-900 font-medium group-hover:underline">
                                    <!-- Populated by JavaScript -->
                                </span>
                            </a>
                        </div>

                        <!-- Response Time -->
                        <div>
                            <h3 class="text-xs font-semibold text-neutral-400 uppercase tracking-widest mb-4">
                                What to Expect
                            </h3>
                            <ul class="space-y-3 text-sm text-neutral-600">
                                <li class="flex items-start gap-3">
                                    <span class="h-1 w-1 bg-neutral-400 rounded-full flex-shrink-0 mt-2"></span>
                                    I typically respond within 1-2 business days
                                </li>
                                <li class="flex items-start gap-3">
                                    <span class="h-1 w-1 bg-neutral-400 rounded-full flex-shrink-0 mt-2"></span>
                                    All inquiries receive a thoughtful response
                                </li>
                                <li class="flex items-start gap-3">
                                    <span class="h-1 w-1 bg-neutral-400 rounded-full flex-shrink-0 mt-2"></span>
                                    No commitment required for initial conversations
                                </li>
                            </ul>
                        </div>

                        <!-- Note -->
                        <p class="text-xs text-neutral-400 leading-relaxed">
                            Please include as much context as helpful about your project or question.
                            The more I understand upfront, the more useful my response can be.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    @if (!string.IsNullOrEmpty(recaptchaSiteKey))
    {
        <script src="https://www.google.com/recaptcha/api.js?render=@recaptchaSiteKey"></script>
        <script>
            document.getElementById('contactForm')?.addEventListener('submit', function(e) {
                e.preventDefault();

                const form = this;
                const submitBtn = document.getElementById('submitBtn');
                const btnText = submitBtn.querySelector('.btn-text');
                const btnLoading = submitBtn.querySelector('.btn-loading');

                // Show loading state
                btnText.classList.add('hidden');
                btnLoading.classList.remove('hidden');
                submitBtn.disabled = true;

                // Execute reCAPTCHA
                grecaptcha.ready(function() {
                    grecaptcha.execute('@recaptchaSiteKey', { action: 'contact_form' }).then(function(token) {
                        // Set the token in the hidden field
                        document.getElementById('recaptchaToken').value = token;
                        // Submit the form
                        form.submit();
                    }).catch(function(error) {
                        console.error('reCAPTCHA error:', error);
                        // Reset button state
                        btnText.classList.remove('hidden');
                        btnLoading.classList.add('hidden');
                        submitBtn.disabled = false;
                        alert('Security verification failed. Please try again.');
                    });
                });
            });
        </script>
    }
    else
    {
        <script>
            // Development mode without reCAPTCHA - just show loading state
            document.getElementById('contactForm')?.addEventListener('submit', function(e) {
                const submitBtn = document.getElementById('submitBtn');
                const btnText = submitBtn.querySelector('.btn-text');
                const btnLoading = submitBtn.querySelector('.btn-loading');

                btnText.classList.add('hidden');
                btnLoading.classList.remove('hidden');
                submitBtn.disabled = true;

                // Set a dummy token for development
                document.getElementById('recaptchaToken').value = 'development-mode-token';
            });
        </script>
    }

    <script>
        // Build email address from data attributes to prevent scraping
        document.addEventListener('DOMContentLoaded', function() {
            const link = document.getElementById('contact-email');
            const text = document.getElementById('contact-email-text');
            if (link && text) {
                const user = link.dataset.user;
                const domain = link.dataset.domain;
                const email = user + '@@' + domain;
                link.href = 'mailto:' + email;
                text.textContent = email;
            }
        });
    </script>
}
